---
title: "[CJOlivenetworks] CGV Fast Order 시스템 인프라 구축 2. Terraform / Terraform Cloud 를 활용한 Cloud Infra 구축 자동화"
categories:
  - Cloud-Wave-Project
tags:
  - Cloud-Wave-Project
toc: true
toc_sticky: true
toc_label: "Carefree to See"
header:
   teaser: "/assets/images/CloudWave/project/terraform2.png"
---
<!-- Created by Chae Seung Min - CarefreeLife
Visit my Programming blog: https://carefreelife98.github.io --> 
---

# Terraform 을 통한 Cloud Infra 자동화

<img src="/assets/images/CloudWave/project/terraform2.png" alt="terraform2_Procdess" width="100%" min-width="200px" itemprop="image"><br>[사진 출처: Hashicorp](https://www.hashicorp.com/products/terraform)<br>

- IaC(Infrastructure as Code)는 수동 작업 대비 일관성 유지, 재사용성, 자동화 측면 향상.
  - 테라폼은 cloudformation, pulumi와 같은 IaC 방법론을 실현하는 도구 중 하나.
    - IaC 이전의 Cloud Infra 관리는 웹 콘솔이 주류로 사용.
    - 콘솔로도 작업은 가능하지만 대규모 / 반복적 작업을 수행하는 경우 매우 비효율적.
- 가령 필요에 따라 dev 환경의 생성 및 제거 작업이 반복적으로 필요한 경우
  - 해당 dev VPC에는 각 3개의 퍼블릭/프라이빗 서브넷을 갖고, 퍼블릭엔 서비스 확인을 위한 접근용 ALB / 프라이빗엔 WEB, WAS 서버 및 RDS가 구성되어야 하고, 각 ALB와 EC2에 대하여 쉬운 접근을 위해 Route53 도메인을 붙이는 것이 필요 조건.
  - 해당 과정을 수동으로 진행한다면 리소스 tag 규칙등의 과정에서 입력 실수로 인해 누락/오입력이 발생하고, 일관성의 훼손 가능성 증가.
  - 생성 및 재생성 과정을 일일히 생성하면 시간도 오래 걸리고, 비효율적이다. 그러나 코드로 구성되어, 필요할때마다 복제하고 재생성 한다면 매우 효율적.

<br>

<img src="/assets/images/CloudWave/project/terraformCode.png" alt="terraformCode_Procdess" width="100%" min-width="200px" itemprop="image"><br>`작성한 Terraform code - main.tf 중 일부분.`<br>

<br><br>

# Terraform 기본 Command

```shell
# 현재 디렉토리 초기화
$ terraform init

# Terraform 이 어떤 작업을 하게 될 지 Dry-Run
$ terraform plan

# 해당 코드를 apply하여 적용하고 Build.
$ terraform apply

# Terraform 으로 구축된 것 삭제
$ terraform destroy

# state file 새로고침
$ terraform refresh

# Terraform output 보기
$ terraform output

# Dot-formatted graph 생성
$ terraform graph
```

<br><br>

# tfenv 를 사용하여 Terraform 설치하기

1. tfenv clone 설치
>    
>    ```bash
>    $ git clone https://github.com/tfutils/tfenv.git ~/.tfenv
>    ```

2. Terraform 특정 버전 설치
> <img src="/assets/images/CloudWave/project/tfenv1.png" alt="tfenv1_Procdess" width="100%" min-width="200px" itemprop="image"><br><br>

3. Terraform 특정 버전 설치 확인
>
>    ```bash
>    $ tfenv list
>    ```
>
> <img src="/assets/images/CloudWave/project/tfenv2.png" alt="tfenv2_Procdess" width="100%" min-width="200px" itemprop="image"><br><br>

4. 특정 버전의 Terraform 사용하기
>
>    ```bash
>    $ tfenv use (버젼 명시)
>    $ terraform --version
>    ```
> <img src="/assets/images/CloudWave/project/tfenv3.png" alt="tfenv3_Procdess" width="100%" min-width="200px" itemprop="image"><br><br>

5. 특정 버전의 Terraform 삭제하기
>
>    ```bash
>    $ tfenv uninstall (버전 명시)
>    ```
> <img src="/assets/images/CloudWave/project/tfenv4.png" alt="tfenv5_Procdess" width="100%" min-width="200px" itemprop="image"><br><br>

<br><br>

# [Terraform Cloud] VCS 연동 후 CI / CD 환경에서 Cloud Infra 구축하기

- **UI integration**
- **버전 관리 시스템 (VCS)**
- **API Driven Workflows**
- **중앙 관리형**
- **Private Module Registry 제공**
- **Sentinel Policy Ensforcement**
  - IAM Policy?
- **Single Sign-on**
  - 사용자가 여러 웹 애플리케이션 또는 서비스에 대해 단일 인증을 사용하여 한 번의 로그인으로 여러 서비스에 액세스할 수 있는 인증 메커니즘
  - 이는 사용자 경험을 향상시키고 비밀번호 관리의 어려움을 줄이는 것에 도움.
  - SSO 시스템은 일반적으로 중앙 인증 서비스를 사용하여 여러 애플리케이션 간의 인증을 처리.
- **Secure API credentials**

<br><br>

<h1>[Terraform Cloud] 시작하기</h1>

<img src="/assets/images/CloudWave/project/tfstart.png" alt="tfstart_Procdess" width="100%" min-width="200px" itemprop="image"><br>`terraform 시작하기`<br>

- Terraform Cloud 에서 제공하는 Sample 을 이용해서 시작해보자.

<br><br>

1. Terraform login
>    ```shell
>    $ terraform login
>    ```
>    
>    <img src="/assets/images/CloudWave/project/tflogin.png" alt="tflogin_Procdess" width="100%" min-width="200px" itemprop="image"><br>`terraform login`<br><br>
>    <img src="/assets/images/CloudWave/project/tflogin2.png" alt="tflogin2_Procdess" width="100%" min-width="200px" itemprop="image"><br>`terraform login 시 자동으로 웹 창으로 이동하게 된다.`<br><br>
>    <img src="/assets/images/CloudWave/project/tflogin3.png" alt="tflogin3_Procdess" width="100%" min-width="200px" itemprop="image"><br>`Token 발급 후 로그인이 되는 것을 볼 수 있다.`<br><br>

2. Terraform Sample repository 클론
>    ```bash
>    $ git clone https://github.com/hashicorp/tfc-getting-started.git
>    ```
>
>  - 인프라 자원을 Provisionning 하기 위한 Configuration 파일.
>  - infra 자원은 `fake web service` 사용 (AWS-ec2 와 비슷한 가짜 자원을 생성)<br>
>    [링크: registry.terraform.io/providers/hashicorp/fakewebservices/latest](https://registry.terraform.io/providers/hashicorp/fakewebservices/latest)

3. setup script 실행
>    <img src="/assets/images/CloudWave/project/tfstart2.png" alt="tfstart2_Procdess" width="100%" min-width="200px" itemprop="image"><br>작업 시작 전 Local PC에 `jq` 가 설치되어 있는 지 확인 할 것. (없다면 설치) <br>
>
>    ```bash
>    $ cd tfc-getting-started
>    $ ./scripts/setup.sh
>    ```
>
>    - configuration 초기화

<br><br>

# [Terraform Cloud] Example Configuration

1. Workspace
  - Name: getting-started
  - URL : [https://app.terraform.io/app/example-org-1b7e9c/workspaces/getting-started](https://app.terraform.io/app/example-org-1b7e9c/workspaces/getting-started)<br><br>

2. Terraform init
> <img src="/assets/images/CloudWave/project/tfconf.png" alt="tfconf_Procdess" width="100%" min-width="200px" itemprop="image"><br>`Terraform init`<br>

3. Terraform plan
> <img src="/assets/images/CloudWave/project/tfconf2.png" alt="tfconf2_Procdess" width="100%" min-width="200px" itemprop="image"><br>`Terraform plan`<br>
> - Terraform Plan 은 Local의 내 맥북에서 init 되었지만, Terraform Cloud에서 실행되고 있음.
>
>> `Terraform Cloud runs Terraform on disposable virtual machines in its own cloud infrastructure.`
>
- 테라폼 클라우드 내 클라우드 환경의 VM에서 테라폼이 실행됨.
>
>> `This 'remote execution' helps provide consistency and visibility for critical provisioning operations.`
>
- 위와 같은 Cloud 환경에서의 원격 실행은 Provisioning 작업에 관해 일관성과 가시성을 제공.
>
>> `It also enables notifications, version control integration, and powerful features like Sentinel policy enforcement and cost estimation (shown in the output above).`
>
- 또한 원격 실행은 알림 및 버전 컨트롤 (VCS) 기능, 보안 및 비용 관리를 수월하게 해줌.

4. Terraform apply
> <img src="/assets/images/CloudWave/project/tfconf3.png" alt="tfconf3_Procdess" width="100%" min-width="200px" itemprop="image"><br>`Terraform apply`<br>
- Apply 하게 되면 Team&Governance 기능을 사용할 수 있는 30일 무료 체험 organization이 생성됨.<br>
  → 무료체험 기간이 끝나면 자동으로 Free tier로 변경되니 걱정 ㄴㄴ

















<img src="/assets/images/CloudWave/project/naming.png" alt="naming_Procdess" width="100%" min-width="200px" itemprop="image"><br>`(주)구름 건설의 Naming Rule`<br>


[//]: # (<span style="color:green">``</span>)

[//]: # ()
[//]: # ({: .notice--danger})

[//]: # ({: style="text-align: center;"})

[//]: # ()
[//]: # (<details>)

[//]: # (<summary><span style="color:blue">&#40;클릭&#41;</span></summary>)

[//]: # (<div markdown="1">       )

[//]: # ()
[//]: # (</div>)

[//]: # (</details>)


<br><br>

허용 가능한 만큼의 학습 내용을 복습 겸 이곳에 포스팅 해보려고 합니다.<br><br>
혹시 이해가 안가거나 추가적인 설명이 필요한 부분, 오류 등의 피드백은 언제든지 환영합니다!<br><br>
긴 글 읽어주셔서 감사합니다. 포스팅을 마칩니다.<br>
{: .notice--success}
{: style="text-align: center;"}

<br><br>

[처음으로~](#){: .btn .btn--primary }

### Task Lists

>

- [x] 
- [x] 
- [x] 
- [x] 
- [x] 
- [x] 
- [x] 
- [x] 
- [x] 